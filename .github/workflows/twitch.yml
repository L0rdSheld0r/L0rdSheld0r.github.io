name: Update Twitch Stats

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:

jobs:
  twitch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install tools
        run: sudo apt-get install -y curl jq

      - name: Get Twitch stats
        env:
          CLIENT_ID: ${{ secrets.TWITCH_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.TWITCH_CLIENT_SECRET }}
        run: |
          echo "Getting access token..."
          TOKEN=$(curl -s -X POST \
            "https://id.twitch.tv/oauth2/token?client_id=$CLIENT_ID&client_secret=$CLIENT_SECRET&grant_type=client_credentials" \
            | jq -r '.access_token')

           # New talent list location
          TALENTS_FILE=".github/data/twitch_talents.txt"
          OUTPUT_FILE=".github/data/twitch_stats.json"

          echo '{ "talents": [' > "$OUTPUT_FILE"

          while IFS= read -r NAME || [ -n "$NAME" ]; do
            NAME=$(echo "$NAME" | xargs)  # trim whitespace
            [ -z "$NAME" ] && continue    # skip empty lines

            echo "Processing $NAME..."

            # Get user ID
            USER=$(curl -s \
              "https://api.twitch.tv/helix/users?login=$NAME" \
              -H "Client-ID: $CLIENT_ID" \
              -H "Authorization: Bearer $TOKEN")

            USER_ID=$(echo $USER | jq -r '.data[0].id')

            # Get follower count
            FOLLOWERS=$(curl -s \
              "https://api.twitch.tv/helix/channels/followers?broadcaster_id=$USER_ID" \
              -H "Client-ID: $CLIENT_ID" \
              -H "Authorization: Bearer $TOKEN" \
              | jq -r '.total')

            # Get last 5 streams (archives)
            VIDEOS=$(curl -s \
              "https://api.twitch.tv/helix/videos?user_id=$USER_ID&type=archive&first=5" \
              -H "Client-ID: $CLIENT_ID" \
              -H "Authorization: Bearer $TOKEN" \
              | jq '.data')

            # Append talent data
            echo "{
              \"username\": \"$NAME\",
              \"followers\": $FOLLOWERS,
              \"videos\": $VIDEOS
            }," >> "$OUTPUT_FILE"

          done < "$TALENTS_FILE"

          # Remove trailing comma and close JSON
          sed -i '$ s/,$//' "$OUTPUT_FILE"
          echo ']}' >> "$OUTPUT_FILE"

          # Commit & push
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add "$OUTPUT_FILE"
          git commit -m "Update Twitch stats"
          git push
